<!DOCTYPE html>
<html lang="en">

<head>
    <title>Python Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style/fonts.css">
    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="vendor/xterm/css/xterm.css" />
</head>

<body>
    <div class="wrapper">
        <div class="topbar">

        </div>

        <div class="interface">

            <div class="leftBar">
                <div class="top">
                </div>

                <div class="bottom">
                    <img id="runSwitch" onclick="switchRun()" class="active" src="python.svg">
                    <img id="consoleSwitch" onclick="switchConsole()" src="terminal.svg">
                </div>
            </div>

            <div class="workzone workzone-vertical">
                <div class="editor-container">
                    <div id="editor"></div>
                </div>
                <div id="outputWin" class="window window-light">
                    <div class="toolbar">
                        <div class="left">
                            <span class="title">Run</span>
                        </div>
                        <div class="right">
                            <img title="reload interpreter" id="reloadBtn" onclick="reload()" src="reload.svg">
                            <img title="run" id="runBtn" onclick="run()" src="run.svg">
                            <img title="Switch layout" class="colored" id="vertiHoriSwitch" onclick="toggleVertiHori()"
                                src="right.svg">
                        </div>
                    </div>
                    <textarea id="output" disabled>Initializing...</textarea>
                </div>

                <div id="consoleWin" style="display: none;" class="window window-light">
                    <div class="toolbar">
                        <div class="left">
                            <span class="title">Console</span>
                        </div>
                        <div class="right">
                            <select onchange="refreshTerm()" title="select python runtime" id="runtimeSelecter">
                                <option value="editor">Current Code</option>
                                <option value="console">Console</option>
                            </select>
                            <img title="reload interpreter" id="consoleReloadBtn" onclick="termReload()" src="reload.svg">
                            <img title="Switch layout" class="colored" id="consoleLayoutBtn" onclick="toggleVertiHori()"
                                src="right.svg">
                        </div>
                    </div>
                    <textarea style="position: absolute;;height: 1rem; width: 50%;" id="consoleOutput"
                        disabled>Your browser does not support console</textarea>
                    <div style="width: 100%;height: calc(100% - 2.5rem);" id="terminal"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="vendor/ace/ace.js" type="text/javascript" charset="utf-8"></script>

    <script>
        const outputWinDOM = document.getElementById("outputWin");
        const consoleWinDOM = document.getElementById("consoleWin");
        const consoleSwitchDOM = document.getElementById("consoleSwitch");
        const runSwitchDOM = document.getElementById("runSwitch");
        const outputDOM = document.getElementById("output");
        const runBtnDOM = document.getElementById("runBtn");
    </script>

    <script>
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/custom");
        editor.session.setMode("ace/mode/python");
        editor.resize();
        editor.setFontSize(15)

        var Range = ace.require('ace/range').Range
        var errMarkerID;
        var errLine;

        editor.session.on('change', function (delta) {
            if (delta.start.row + 1 == errLine) {
                editor.session.removeMarker(errMarkerID);
            }
            // delta.start, delta.end, delta.lines, delta.action
        });

        function toggleVertiHori() {
            let outputSwitchBtn = document.getElementById("vertiHoriSwitch");
            let consoleSwitchBtn = document.getElementById("consoleLayoutBtn");
            let workzone = document.getElementsByClassName("workzone")[0];
            
            if (workzone.classList.contains("workzone-vertical")) {
                workzone.classList.remove("workzone-vertical");
                outputSwitchBtn.src = "bottom.svg";
                consoleSwitchBtn.src = "bottom.svg";
                term.resize(parseInt(window.innerWidth * 0.04), parseInt(window.innerHeight * 0.05))
            } else {
                workzone.classList.add("workzone-vertical");
                outputSwitchBtn.src = "right.svg";
                consoleSwitchBtn.src = "right.svg";
                term.resize(parseInt(window.innerWidth * 0.1), parseInt(window.innerHeight * 0.017))
            }
            editor.resize();
        }

        var pythonRuntimes = [];
        pythonRuntimes.push(new Worker("py-worker.js"));

        function getMainPy() {
            if (pythonRuntimes[0] === undefined) {
                pythonRuntimes[0] = new Worker("py-worker.js");
            }
            return pythonRuntimes[0]
        }

        function run() {
            let thisPy = getMainPy()
            let code = editor.getValue();
            runBtnDOM.onclick = undefined;
            if (outputDOM.value!="Initializing...") {
                runBtnDOM.src = "stop.svg";
                runBtnDOM.classList.add("colored");
            }
            thisPy.postMessage(code)
            thisPy.onmessage = function (event) {
                const { output, status, errorInfo } = event.data;
                
                if (!mainInit) { // Initial run
                    outputDOM.value = status === "success" ? "Ready!" : output;
                    mainInit = true;
                } else {
                    // Display the output
                    outputDOM.value = output;
                    
                    // Handle error case
                    if (status === "fail") {
                        outputDOM.value += "\n\nProgram finished with error"
                        // Extract line number from error message
                        const regex = /Line (\d+)/g;
                        const matches = output.matchAll(regex);
                        let lastMatch;
                        for (const match of matches) {
                            lastMatch = match;
                        }
                        
                        if (lastMatch) {
                            const lineNumber = lastMatch[1];
                            errLine = lineNumber;
                            errMarkerID = editor.session.addMarker(new Range(lineNumber - 1, 0, lineNumber, 0), "highlight-red", "text")
                        } else {
                            console.log(`No line number found in error message: ${output}`);
                        }
                    } else {
                        outputDOM.value += "\n\nProgram finished"
                    }
                }
                runBtnDOM.classList.remove("colored");
                runBtnDOM.src = "run.svg"
                runBtnDOM.onclick = run;
            }
        }

        function reloadRuntime(index) {
            if (pythonRuntimes[index] !== undefined) {
                pythonRuntimes[index].terminate();
                pythonRuntimes[index] = undefined;
            }
        }

        function reload() {
            reloadRuntime(0);
            outputDOM.value = "";
        }

        var mainInit = false;
        run();

        // Switch to console window
        function switchConsole() {
            // Init console on first launch
            if (consoleWinDOM.style.display == "none") {
                if (!consoleInit && outputDOM.value != "") {
                    termRun(`import sys
print(f'''Python {sys.version}''')`)
                    consoleInit = true;
                }
                outputWinDOM.style.display = "none";
                consoleWinDOM.style.display = "";
                runSwitchDOM.classList.remove("active")
                consoleSwitchDOM.classList.add("active")
            } else {
                consoleWinDOM.style.display = "none";
                consoleSwitchDOM.classList.remove("active")
            }
        }
        // Switch to run/output window
        function switchRun() {
            if (outputWinDOM.style.display == "none") {
                outputWinDOM.style.display = "";
                consoleWinDOM.style.display = "none";
                consoleSwitchDOM.classList.remove("active")
                runSwitchDOM.classList.add("active")
            } else {
                outputWinDOM.style.display = "none";
                runSwitchDOM.classList.remove("active")
            }
        }
    </script>
    <script src="vendor/xterm/lib/xterm.js"></script>
    <script>
        var lightTheme = {
            foreground: '#000000',
            background: '#ffffff',
            selection: '#add2ff',
            cursor: "#00000080",
        };
        var keyMap = {
            backspace: '\x7F',
            left: '\x1B[D',
            right: '\x1B[C',
            up: '\x1B[A',
            down: '\x1B[B',
            enter: '\r',
            ctrl_c: '\x03',
        }
        var cmdLength = 0;
        var cursorPosition = 0;
        var traceIndex = 0;
        var inputs = [];
        var curInput = "";

        var consoleInit = false;

        var term = new Terminal({
            cols: parseInt(window.innerWidth * 0.1),
            rows: parseInt(window.innerHeight * 0.017),
            theme: lightTheme,
            cursorBlink: true,
        });
        term.open(document.getElementById('terminal'));

        function getTermPy() {
            if (document.getElementById("runtimeSelecter").value == "editor") {
                return getMainPy();
            } else {
                if (pythonRuntimes[1] === undefined) {
                    pythonRuntimes[1] = new Worker("py-worker.js");
                }
                return pythonRuntimes[1];
            }
        }

        function termRun(code = null) {
            let thisPy = getTermPy();
            if (code) { // use code passed in
                thisPy.postMessage(code)
            } else { // read code from terminal
                thisPy.postMessage(inputs[inputs.length - 1])
            }
            thisPy.onmessage = function (event) {
                const { output, status } = event.data;

                // Display the output
                const lines = output.split("\n");
                for (let line of lines) {
                    term.write("\n\r" + line);
                }
                term.write("\n\r>>> ")
            }
        }

        function termReload() {
            if (document.getElementById("runtimeSelecter").value == "editor") {
                reloadRuntime(0);
            } else {
                reloadRuntime(1);
            }
            refreshTerm()
        }

        function refreshTerm() {
            term.reset();
            termRun(`import sys
print(f'''Python {sys.version}''')`)
        }

        // hotkeys and keys
        term.onKey(e => {
            if (e.key == keyMap.enter) {
                if (curInput.length > 0) {
                    inputs.push(curInput)
                }
                curInput = "";
                cmdLength = 0;
                cursorPosition = 0;
                traceIndex = 0;
                termRun();
                // console.log(inputs);
            } else if (e.key == keyMap.backspace) {
                if (cursorPosition > 0) {
                    term.write('\b \b')
                    let head = curInput.substr(0, cursorPosition - 1);
                    let tail = curInput.substr(cursorPosition, curInput.length);
                    curInput = head + tail;
                    term.write(tail + " ")
                    for (let i = 0; i < tail.length + 1; i++) {
                        term.write(keyMap.left)
                    }
                    cursorPosition -= 1;
                    cmdLength -= 1;
                }
            } else if (e.key == keyMap.left) {
                if (cursorPosition > 0) {
                    term.write(keyMap.left)
                    cursorPosition -= 1;
                }
            } else if (e.key == keyMap.right) {
                if (cursorPosition < cmdLength) {
                    term.write(keyMap.right)
                    cursorPosition += 1;
                }
            } else if (e.key == keyMap.up) {

            } else if (e.key == keyMap.down) {

            } else if (e.key == keyMap.ctrl_c) {
                term.write('\n\r>>> ');
                curInput = "";
                cmdLength = 0;
                cursorPosition = 0;
                traceIndex = 0;
            } else if (!e.key.includes('\\') || e.key == "\\") { // exclude key combinations
                if (cursorPosition == curInput.length) { // If it's at the end of this line
                    curInput += e.key;
                    term.write(e.key);
                } else { // If it's not at the end of this line
                    let head = curInput.substr(0, cursorPosition);
                    let tail = curInput.substr(cursorPosition, curInput.length);
                    curInput = head + e.key + tail;
                    term.write(e.key + tail)
                    for (let i = 0; i < tail.length; i++) {
                        term.write(keyMap.left)
                    }
                }
                cursorPosition += 1;
                cmdLength += 1;
            }
        })
    </script>
</body>

</html>
